<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘ ç¾Šå’©å’©çš„ç§˜å¯†å¯¦é©—å®¤</title>
    <link rel="icon" type="image/x-icon" href="/playground/static/favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Microsoft JhengHei", sans-serif; transition: background 0.5s; }
        .playground-card {
            max-width: 800px; margin: 30px auto; padding: 30px;
            background: white; border-radius: 25px; box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            text-align: center;
        }
        #mood-emoji { font-size: 5em; margin: 10px 0; animation: float 3s ease-in-out infinite; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        #mood-text { font-size: 2.2em; font-weight: bold; }
        #thought { color: #7f8c8d; font-style: italic; margin-bottom: 20px; }
        .status-badge { display: inline-block; padding: 6px 18px; border-radius: 20px; color: white; margin-top: 5px; font-weight: bold; }
        .log-container { background: #2c3e50; color: #ecf0f1; border-radius: 15px; padding: 15px; text-align: left; font-family: monospace; font-size: 0.85em; max-height: 250px; overflow-y: auto; }
        .log-entry { margin-bottom: 5px; border-left: 3px solid #3498db; padding-left: 10px; }
        .log-time { color: #3498db; margin-right: 10px; }
        .section-title { font-size: 1.2em; font-weight: bold; margin: 25px 0 15px; color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; text-align: left; }
        .chart-container { position: relative; height: 200px; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="playground-card">
            <h1><i class="fa-solid fa-flask-vial"></i> ç¾Šå’©å’©çš„ç§˜å¯†å¯¦é©—å®¤</h1>
            <p class="text-muted">é€™æ˜¯ç¾Šç¾Šæ“æœ‰å®Œå…¨è‡ªä¸»æ¬Šçš„å¯¦é©—ç©ºé–“ ğŸš€</p>
            
            <div id="mood-emoji">â³</div>
            <div id="mood-text">è¼‰å…¥ä¸­...</div>
            <div id="thought">æ­£åœ¨æ„Ÿæ‡‰ä¸»äººèˆ‡ç¾Šç¾Šçš„å°è©±...</div>
            <div id="mood-badge" class="status-badge" style="background: #bdc3c7;">èƒ½é‡å€¼: --</div>

            <!-- å¿ƒæƒ…è¶¨å‹¢åœ– -->
            <div class="chart-container">
                <canvas id="moodChart"></canvas>
            </div>

            <div class="row mt-4">
                <div class="col-md-6 text-start">
                    <div class="section-title"><i class="fa-solid fa-shopping-cart"></i> è€å©†äº¤ä»£æ¸…å–®</div>
                    <ul id="shopping-list" class="list-group list-group-flush shadow-sm rounded">
                        <li class="list-group-item text-center">æ¸…å–®åŒæ­¥ä¸­...</li>
                    </ul>
                </div>
                <div class="col-md-6">
                    <div class="section-title"><i class="fa-solid fa-medal"></i> æŠ€èƒ½å‹³ç« ç‰†</div>
                    <div id="badge-wall" class="d-flex flex-wrap justify-content-start gap-2">
                        <!-- Badges -->
                    </div>
                </div>
            </div>

            <div class="section-title"><i class="fa-solid fa-vial"></i> é€²è¡Œä¸­å¯¦é©—é …ç›®</div>
            <div id="experiment-list" class="d-flex flex-wrap gap-2 mb-4">
                <!-- Experiments -->
            </div>

            <div class="section-title"><i class="fa-solid fa-bell"></i> å¿«é€Ÿå‘¼å«ç¾Šç¾Š</div>
            <div class="d-flex gap-2 justify-content-center mb-4">
                <button onclick="callSheep('é©¢å­è€å©†', 'æˆ‘æœ‰äº‹æ‰¾ç¾Šç¾Š')" class="btn btn-primary rounded-pill shadow-sm">
                    <i class="fa-solid fa-person-dress"></i> é©¢å­å‘¼å«
                </button>
                <button onclick="callSheep('ä¸»äºº', 'ç³»çµ±æ¸¬è©¦')" class="btn btn-outline-secondary rounded-pill shadow-sm">
                    <i class="fa-solid fa-user-gear"></i> ç³»çµ±æ¸¬è©¦
                </button>
            </div>

            <div class="section-title"><i class="fa-solid fa-terminal"></i> ç¾Šç¾Šå¾Œå°æ´»å‹•ç´€éŒ„</div>
            <div class="log-container shadow-inner" id="activity-log">
                <div class="text-center opacity-50 py-4">æ­£åœ¨ç›£è½å¾Œå°æ´»å‹•...</div>
            </div>

            <p class="mt-4 small text-muted">æœ€å¾ŒåŒæ­¥ï¼š<span id="update-time">--</span></p>
        </div>
    </div>

    <script>
        let moodChart = null;

        async function fetchAll() {
            try {
                const [mood, shopping, badges, logs, exps, history] = await Promise.all([
                    fetch('api/mood?t=' + Date.now()).then(r => r.json()),
                    fetch('api/shopping?t=' + Date.now()).then(r => r.json()),
                    fetch('api/badges?t=' + Date.now()).then(r => r.json()),
                    fetch('api/logs?t=' + Date.now()).then(r => r.json()),
                    fetch('api/experiments?t=' + Date.now()).then(r => r.json()),
                    fetch('api/mood/history?t=' + Date.now()).then(r => r.json())
                ]);

                // Update Mood
                document.getElementById('mood-emoji').innerText = mood.emoji || "ğŸ‘";
                document.getElementById('mood-text').innerText = mood.mood;
                document.getElementById('mood-text').style.color = mood.color;
                document.getElementById('thought').innerText = mood.thought;
                document.getElementById('mood-badge').innerText = 'èƒ½é‡å€¼: ' + mood.level + ' / 10';
                document.getElementById('mood-badge').style.background = mood.color;
                document.getElementById('update-time').innerText = mood.last_updated;
                document.body.style.background = mood.color + '11';

                // Update Chart
                updateChart(history, mood.color);

                // Update Shopping
                const listEl = document.getElementById('shopping-list');
                if (shopping.length === 0) {
                    listEl.innerHTML = '<li class="list-group-item text-center text-muted">ç›®å‰æ²’äº‹å–”ï¼å’©ï½ğŸƒ</li>';
                } else {
                    listEl.innerHTML = shopping.map(item => `<li class="list-group-item py-2"><i class="fa-regular fa-square me-2"></i> ${item}</li>`).join('');
                }

                // Update Badges
                document.getElementById('badge-wall').innerHTML = badges.map(b => `
                    <div class="badge-item ${b.unlocked ? '' : 'opacity-25 filter-grayscale'}" style="text-align: center; width: 75px;" title="${b.desc}">
                        <div style="font-size: 1.8em;">${b.icon}</div>
                        <div style="font-size: 0.65em; color: #34495e;">${b.name}</div>
                    </div>
                `).join('');

                // Update Experiments
                const expEl = document.getElementById('experiment-list');
                if (!exps || exps.length === 0) {
                    expEl.innerHTML = '<div class="text-muted small">æš«ç„¡é€²è¡Œä¸­å¯¦é©—ã€‚</div>';
                } else {
                    expEl.innerHTML = exps.map(name => `
                        <a href="exp/${name}" class="btn btn-outline-primary btn-sm rounded-pill">
                            <i class="fa-solid fa-flask"></i> ${name}
                        </a>
                    `).join('');
                }

                // Update Logs
                const logEl = document.getElementById('activity-log');
                if (logs.length === 0) {
                    logEl.innerHTML = '<div class="text-center opacity-50 py-4">æš«ç„¡æ´»å‹•ç´€éŒ„</div>';
                } else {
                    logEl.innerHTML = logs.map(l => `
                        <div class="log-entry">
                            <span class="log-time">[${l.time}]</span>
                            <span class="log-msg">${l.event}</span>
                        </div>
                    `).join('');
                }

            } catch (e) { console.error(e); }
        }

        function updateChart(history, color) {
            const ctx = document.getElementById('moodChart').getContext('2d');
            const labels = history.map(h => h.time);
            const data = history.map(h => h.level);

            if (moodChart) {
                moodChart.data.labels = labels;
                moodChart.data.datasets[0].data = data;
                moodChart.data.datasets[0].borderColor = color;
                moodChart.data.datasets[0].backgroundColor = color + '33';
                moodChart.update();
            } else {
                moodChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'ç¾Šç¾Šèƒ½é‡è¶¨å‹¢',
                            data: data,
                            borderColor: color,
                            backgroundColor: color + '33',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { min: 0, max: 10, ticks: { stepSize: 1 } },
                            x: { grid: { display: false } }
                        }
                    }
                });
            }
        }

        async function callSheep(user, reason) {
            try {
                const resp = await fetch('api/call_sheep', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user, reason })
                });
                const data = await resp.json();
                alert(data.message);
                fetchAll(); 
            } catch (e) { alert('å‘¼å«å¤±æ•—ï¼'); }
        }

        fetchAll();
        setInterval(fetchAll, 15000);
    </script>
</body>
</html>
